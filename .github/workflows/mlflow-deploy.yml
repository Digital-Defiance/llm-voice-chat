name: "MLFlow: Deploy"

on:
  workflow_dispatch:
    inputs:
      machine:
        description: 'Which machine to use'
        required: true
        default: 'mlflow'
        type: choice
        options:
          - mlflow
          - local

jobs:
  deploy-mlflow:
    name: Deploy MLFlow
    timeout-minutes: 1440 # 24h
    runs-on: ${{ inputs.machine }}
    env:
      MLFLOW_AUTH_CONFIG_PATH: "${{ github.workspace }}/auth.ini"
      MLFLOW_HOST: 0.0.0.0
      MLFLOW_PORT: 8000
      
    steps:
      - run: pip install psycopg2-binary # required for mlflow to talk to postgres
      - run: pip install boto3
      - run: pip install mlflow==2.11.1
      - name: Setup auth config
        shell: python
        run: |
          with open("${{ github.workspace }}/auth.ini", "w") as file:
            file.write("""
          [mlflow]
          admin_username = ${{ secrets.MLFLOW_USERNAME }}
          admin_password = ${{ secrets.MLFLOW_PASSWORD }}
          default_permission = READ
          database_uri = sqlite:///sqlite.db
            """)
      - name: Run server
        run: python -m mlflow server --app-name basic-auth --workers 2 --backend-store-uri ${{ secrets.DB_URI }}
    
